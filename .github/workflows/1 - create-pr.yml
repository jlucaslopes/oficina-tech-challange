name: 1 - create-pr.yml

on:
  push:
    branches:
      - 'feat**'
permissions:
  contents: write
  pull-requests: write

jobs:
  build-test-install:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Executar mvn test
        run: mvn test --batch-mode

      - name: Executar mvn install
        run: mvn install --batch-mode -DskipTests=true

  create-pr:
    needs: build-test-install
    runs-on: ubuntu-latest
    steps:
      - name: Verificar se h√° PR existente
        id: check_pr
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:${{ github.ref_name }}&base=develop&state=open
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_GITHUB }}

      - name: Definir flag de PR aberto
        id: set_flag
        run: |
          PR_COUNT=$(echo '${{ steps.check_pr.outputs.data }}' | jq length)
          echo "HAS_OPEN_PR=$PR_COUNT" >> $GITHUB_ENV
          echo "N√∫mero de PRs abertos: $PR_COUNT"

      - name: Criar Pull Request manualmente via API
        if: env.HAS_OPEN_PR == '0'
        env:
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
          HEAD_BRANCH: ${{ github.ref_name }}
          BASE_BRANCH: develop
          REPO: ${{ github.repository }}
        run: |
          echo "üõ†Ô∏è Criando Pull Request manualmente de ${HEAD_BRANCH} ‚Üí ${BASE_BRANCH}"
          API_URL="https://api.github.com/repos/${REPO}/pulls"
          TITLE="Feature ‚Üí Develop: ${HEAD_BRANCH}"
          BODY="Pull request autom√°tico criado a partir da branch **${HEAD_BRANCH}**.  
          - Build e testes executados com sucesso ‚úÖ"

          RESPONSE=$(curl -s -X POST -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            ${API_URL} \
            -d "$(jq -n --arg title "$TITLE" --arg head "$HEAD_BRANCH" --arg base "$BASE_BRANCH" --arg body "$BODY" \
            '{title: $title, head: $head, base: $base, body: $body}')")

          PR_URL=$(echo "$RESPONSE" | jq -r '.html_url')
          if [ "$PR_URL" = "null" ] || [ -z "$PR_URL" ]; then
            echo "‚ùå Falha ao criar o Pull Request"
            echo "$RESPONSE"
            exit 1
          else
            echo "‚úÖ Pull Request criado com sucesso: $PR_URL"
          fi
